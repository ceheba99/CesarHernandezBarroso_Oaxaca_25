<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa Interactivo con Login</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
</head>
<body>
    <form id="login-form" onsubmit="event.preventDefault(); if (login()) { mostrarContenido(); }" class="login-form">
        <h2>Iniciar Sesión</h2>
        <label for="username">Usuario</label>
        <input type="text" id="username" name="username" placeholder="Usuario" required autocomplete="username">
        <label for="password">Contraseña</label>
        <input type="password" id="password" name="password" placeholder="Contraseña" required autocomplete="current-password">
        <button type="submit" class="login-button">Iniciar sesión</button>
        <p id="login-message" class="login-message"></p>
    </form>
    <div id="admin-panel" style="display: none;" class="admin-panel">
        <h2>Panel de Administración</h2>
        <div class="admin-controls">
            <input type="text" id="new-username" placeholder="Nuevo nombre de usuario" required autocomplete="new-username">
            <input type="password" id="new-password" placeholder="Nueva contraseña" required autocomplete="new-password">
            <div class="admin-buttons">
                <button onclick="registrarUsuario()">Crear Usuario</button>
                <button onclick="eliminarUsuario()">Eliminar Usuario</button>
            </div>
        </div>
        <button id="logout-button" onclick="cerrarSesion()">Cerrar Sesión</button>
        <p id="create-user-message" class="admin-message"></p>
        <p id="delete-user-message" class="admin-message"></p>
    </div>
    <div id="page-content" style="display: none;" class="content-container">
        <div class="left-panel">
            <div class="chart-container">
                <canvas id="chart" width="400" height="300"></canvas>
            </div>
              <div class="table-container" id="info-table-container">
                <table id="info-table">
                    <thead>
                        <tr>
                            <th>SECCION</th>
                            <th>PVEM</th>
                            <th>MORENA</th>
                            <th>PRI</th>
                            <th>PAN</th>
                            <th>MC</th>
                            <th>MUJER</th>
                            <th>NULOS</th>
                            <th>PT</th>
                            <th>PRD</th>
                            <th>PUP</th>
                            <th>FXMO</th>
                            <th>NAO</th>
                            <th>PAN-PRI</th>
                            <th>PVEM-FXMO</th>
                        </tr>
                    </thead>
                    <tbody id="info-table-body"></tbody> 
                </table>
            </div>
            <button id="toggle-ocultar-btn" class="toggle-button">Alternar ocultar polígonos</button>
        </div>
        <div id="map" class="map-container"></div>
    </div>
    <div id="loader" style="display:none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 20px;">
    <p>Cargando...</p>
    </div>
    <script type="module" src="./usuario.obf.js"></script>
    <script type="module" src="./capa.obf.js"></script>
    <script type="module">
        import { login, registrarUsuario, eliminarUsuario } from './usuario.obf.js';
        import { inicializarMapa, cargarCapaINEGI, cargarCapaOriginal, cargarCapaColonias, toggleOcultarPoligonos } from './capa.obf.js';
        import { mostrarSumaDeColumnas, actualizarGrafico, mostrarDatosCompletos } from './grafico.obf.js';L
        window.login = login;
        window.registrarUsuario = registrarUsuario;
        window.eliminarUsuario = eliminarUsuario;
        window.cargarCapaINEGI = cargarCapaINEGI;
        window.cargarCapaOriginal = cargarCapaOriginal;
        window.cargarCapaColonias = cargarCapaColonias;
        window.mostrarSumaDeColumnas = mostrarSumaDeColumnas;
        window.actualizarGrafico = actualizarGrafico;
        window.mostrarDatosCompletos = mostrarDatosCompletos;
        window.toggleOcultarPoligonos = toggleOcultarPoligonos;
        window.addEventListener('beforeunload', function () {
            sessionStorage.removeItem('user');
        });
        window.cerrarSesion = function() {
            sessionStorage.removeItem('user');
            location.reload();
        };
        window.mostrarContenido = function mostrarContenido() {
            console.log("Mostrando contenido...");
            const user = JSON.parse(sessionStorage.getItem('user'));
            if (user && user.esAdmin) {
                document.getElementById('admin-panel').style.display = 'block';
            }
            document.getElementById('login-form').style.display = 'none';
            document.getElementById('page-content').style.display = 'flex';
            fetch('https://raw.githubusercontent.com/ceheba99/CesarBarrosoGJSON/main/proyecto%202%2027%20sept.geojson')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error al cargar el GeoJSON');
                }
                return response.json();
            })
            .then(geojsonData => {
                mostrarSumaDeColumnas(geojsonData);
                mostrarDatosCompletos(geojsonData); 
            })
            .catch(error => {
                console.error('Error al procesar el GeoJSON:', error);
                alert('Hubo un error al cargar los datos del mapa. Por favor, inténtalo de nuevo.');
            });
        };
        document.addEventListener('DOMContentLoaded', function() {
            const controlCapas = inicializarMapa();
            cargarCapaOriginal(controlCapas);
            cargarCapaINEGI(controlCapas);
            cargarCapaColonias(controlCapas);
            document.getElementById('toggle-ocultar-btn').addEventListener('click', toggleOcultarPoligonos);
            const user = JSON.parse(sessionStorage.getItem('user'));
            if (user) {
                console.log("Sesión encontrada. Mostrando contenido...");
                mostrarContenido();
            } else {
                console.log("No se encontró sesión activa.");
            }
        });
    </script>    
</body>
</html>
